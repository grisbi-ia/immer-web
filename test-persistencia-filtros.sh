#!/bin/bash

# Test de Persistencia y Restauraci√≥n de Filtros - IMMER
# Script para verificar que la persistencia funciona correctamente

echo "üß™ Test: Persistencia y Restauraci√≥n de Filtros"
echo "=============================================="
echo ""

echo "üìã Instrucciones de prueba paso a paso:"
echo ""

echo "üîç PASO 1: Verificar estado inicial"
echo "1. Abrir http://localhost:5173/shop"
echo "2. Abrir DevTools (F12) ‚Üí Console"
echo "3. Ejecutar: window.debugImmerCatalog.debugLocalStorage()"
echo "4. Verificar que NO hay filtros guardados o est√°n vac√≠os"
echo ""

echo "üíæ PASO 2: Crear estado para persistir"
echo "1. En la p√°gina /shop, aplicar filtros:"
echo "   - Buscar texto: 'bujia'"
echo "   - Seleccionar marca: 'NGK'"
echo "   - Seleccionar grupo: alg√∫n grupo disponible"
echo "   - Navegar a p√°gina 3 o 4"
echo "2. Verificar que aparecen productos filtrados"
echo "3. En console: window.debugImmerCatalog.forcePersistCurrentState()"
echo "4. En console: window.debugImmerCatalog.debugLocalStorage()"
echo "5. ‚úÖ VERIFICAR: Los filtros se guardaron correctamente"
echo ""

echo "üîÑ PASO 3: Simular navegaci√≥n"
echo "1. Navegar a /cart (agregar cualquier producto)"
echo "2. Desde el carrito, hacer clic en 'Seguir Comprando' o navegar a /shop"
echo "3. ‚úÖ VERIFICAR: Los filtros y paginaci√≥n se restauran autom√°ticamente"
echo "4. ‚úÖ VERIFICAR: La p√°gina actual es la misma que antes (3 o 4)"
echo "5. ‚úÖ VERIFICAR: Los productos mostrados coinciden con los filtros"
echo ""

echo "üß™ PASO 4: Verificaci√≥n manual adicional"
echo "1. En console: window.debugImmerCatalog.debugLocalStorage()"
echo "2. ‚úÖ VERIFICAR: timestamp reciente en los filtros guardados"
echo "3. ‚úÖ VERIFICAR: currentPage coincide con la p√°gina mostrada"
echo "4. ‚úÖ VERIFICAR: selectedBrand, selectedGroup no son null"
echo "5. En console: window.debugImmerCatalog.checkCurrentState()"
echo "6. ‚úÖ VERIFICAR: stores actuales coinciden con localStorage"
echo ""

echo "üêõ PASO 5: Debug de problemas"
echo "Si la restauraci√≥n no funciona:"
echo "1. En console: window.debugImmerCatalog.debugLocalStorage()"
echo "2. Verificar si hay datos en localStorage.lastCatalogFilters"
echo "3. Verificar que timestamp no sea muy antiguo (< 30 min)"
echo "4. En console: window.debugImmerCatalog.restoreCatalogState()"
echo "5. Revisar logs de consola para ver d√≥nde falla"
echo ""

echo "üîß PASO 6: Limpiar y reiniciar"
echo "1. En console: window.debugImmerCatalog.clearCatalogState()"
echo "2. Recargar p√°gina (F5)"
echo "3. Repetir desde PASO 1"
echo ""

echo "üìä Puntos cr√≠ticos a verificar:"
echo "- ‚úÖ persistFiltersToStorage() se llama al cambiar filtros (con debounce 300ms)"
echo "- ‚úÖ localStorage contiene datos v√°lidos despu√©s de cambios"
echo "- ‚úÖ persistFiltersImmediately() se llama despu√©s de b√∫squedas exitosas"
echo "- ‚úÖ markNavigationFromShop() persiste antes de navegar al cart/profile"
echo "- ‚úÖ handleBackToShop() marca navegaci√≥n de regreso desde cart"
echo "- ‚úÖ restoreCatalogState() encuentra y lee datos guardados"
echo "- ‚úÖ Filtros y paginaci√≥n se restauran visualmente"
echo "- ‚úÖ B√∫squeda se ejecuta con filtros restaurados"
echo ""

echo "üöÄ Para ejecutar:"
echo "1. cd /home/pvalarezo/grisbi-apps/immer_web"
echo "2. npm run dev"
echo "3. Seguir pasos anteriores"
echo ""

echo "üìÅ Archivos relacionados:"
echo "- src/lib/stores/store.ts (persistencia autom√°tica con debounce)"
echo "- src/lib/util/util.ts (restauraci√≥n, debug y persistencia inmediata)"
echo "- src/routes/shop/+page.svelte (activaci√≥n de restauraci√≥n)"
echo "- src/lib/components/SimpleCart.svelte (persistencia al ir al carrito)"
echo "- src/routes/cart/+page.svelte (marcado de regreso al shop)"
echo "- src/lib/components/UserNavbar.svelte (persistencia al ir al perfil)"
